<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoreo Presupuesto Proyecto</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6; /* Light gray background */
        padding: 20px;
        color: #333;
    }
    h1, h2 {
        color: #1f2937; /* Darker gray for headings */
        margin-bottom: 15px;
        font-weight: 600;
    }
    /* General input, select, button styling */
    input, select, button {
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #d1d5db; /* Light gray border */
        border-radius: 8px; /* Rounded corners */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Subtle shadow */
    }
    button {
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s, transform 0.2s;
    }
    button:hover {
        transform: translateY(-1px);
    }

    /* Form specific styling */
    .form-inline {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 20px;
    }
    .form-inline > * {
        flex: 1 1 150px; /* Adjust flex basis for better responsiveness */
    }

    /* Button specific colors */
    .btn-danger { background-color: #ef4444; color: white; border: none; } /* Red */
    .btn-warning { background-color: #f59e0b; color: white; border: none; } /* Amber */
    .btn-primary { background-color: #3b82f6; color: white; border: none; } /* Blue */
    .btn-success { background-color: #10b981; color: white; border: none; } /* Green for export */
    .btn-danger:hover { background-color: #dc2626; }
    .btn-warning:hover { background-color: #d97706; }
    .btn-primary:hover { background-color: #2563eb; }
    .btn-success:hover { background-color: #059669; }

    /* Table styling */
    table {
        width: 100%;
        border-collapse: separate; /* Use separate to allow border-radius on cells */
        border-spacing: 0; /* Remove space between cell borders */
        margin-top: 20px;
        background-color: #ffffff;
        border-radius: 12px;
        overflow: hidden; /* Ensures rounded corners are applied */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    th, td {
        padding: 12px 15px;
        text-align: left; /* Align text left for better readability */
        border-bottom: 1px solid #e5e7eb; /* Light border between rows */
        font-size: 0.95rem;
    }
    th {
        background-color: #e5e7eb; /* Slightly darker header background */
        font-weight: 700;
        color: #374151; /* Darker text for headers */
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    tr:last-child td {
        border-bottom: none; /* No border for the last row */
    }
    tbody tr:nth-child(even) {
        background-color: #f9fafb; /* Alternate row background for readability */
    }
    tbody tr:hover {
        background-color: #eff6ff; /* Light blue on hover */
        transition: background-color 0.2s;
    }
    /* Specific styling for summary table totals */
    #summaryTable tr.total-auc, #summaryTable tr.total-group, #summaryTable tr.total-subgroup {
        font-weight: 700;
    }
    #summaryTable tr.total-auc {
        background-color: #bfdbfe; /* Light blue */
        color: #1e40af; /* Dark blue text */
        border-top: 2px solid #60a5fa;
    }
    #summaryTable tr.total-group {
        background-color: #dbeafe; /* Lighter blue */
        color: #1c50a0; /* Slightly darker blue text */
        border-top: 1px solid #93c5fd;
    }
    #summaryTable tr.total-subgroup {
        background-color: #e0f2fe; /* Even lighter blue */
        color: #1a478a; /* Darker text for sub-totals */
    }

    /* Chart container styling */
    #progressChart, #grafica {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .form-inline {
            flex-direction: column;
            align-items: stretch;
        }
        .form-inline > * {
            flex: none; /* Remove flex basis on small screens */
            width: 100%; /* Make elements take full width */
            margin-bottom: 10px; /* Add space between stacked elements */
        }
        table, thead, tbody, th, td, tr {
            display: block; /* Make table elements behave like blocks */
        }
        thead tr {
            position: absolute;
            top: -9999px; /* Hide table headers visually */
            left: -9999px;
        }
        tr {
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        td {
            border: none;
            position: relative;
            padding-left: 50%; /* Make space for the pseudo-element label */
            text-align: right;
            border-bottom: 1px solid #eee; /* Light line between cells in stacked rows */
        }
        td:last-child {
            border-bottom: none;
        }
        td:before {
            content: attr(data-label); /* Use data-label for content */
            position: absolute;
            left: 0;
            width: 45%;
            padding-left: 10px;
            font-weight: bold;
            text-align: left;
            white-space: nowrap; /* Prevent label from wrapping */
            color: #4a5568;
        }
        /* Specific data-labels for tables for mobile view */
        #tablaAUCs td:nth-of-type(1):before { content: "Nombre AUC:"; }
        #tablaAUCs td:nth-of-type(2):before { content: "CÃ³digo AUC:"; }
        #tablaAUCs td:nth-of-type(3):before { content: "Acciones:"; }

        #tablaPresupuestos td:nth-of-type(1):before { content: "AUC:"; }
        #tablaPresupuestos td:nth-of-type(2):before { content: "Grupo:"; }
        #tablaPresupuestos td:nth-of-type(3):before { content: "Subgrupo:"; }
        #tablaPresupuestos td:nth-of-type(4):before { content: "Presupuesto MXN:"; }
        #tablaPresupuestos td:nth-of-type(5):before { content: "Gasto Acumulado:"; }
        #tablaPresupuestos td:nth-of-type(6):before { content: "Restante:"; }
        #tablaPresupuestos td:nth-of-type(7):before { content: "% Usado:"; }
        #tablaPresupuestos td:nth-of-type(8):before { content: "Acciones:"; }

        #ordersTable td:nth-of-type(1):before { content: "AUC:"; }
        #ordersTable td:nth-of-type(2):before { content: "Fecha:"; }
        #ordersTable td:nth-of-type(3):before { content: "# Carrito:"; }
        #ordersTable td:nth-of-type(4):before { content: "Orden Compra:"; }
        #ordersTable td:nth-of-type(5):before { content: "Grupo:"; }
        #ordersTable td:nth-of-type(6):before { content: "Subgrupo:"; }
        #ordersTable td:nth-of-type(7):before { content: "Monto MXN:"; }
        #ordersTable td:nth-of-type(8):before { content: "Monto EUR:"; }
        #ordersTable td:nth-of-type(9):before { content: "Comentarios:"; }
        #ordersTable td:nth-of-type(10):before { content: "Contratista:"; }
        #ordersTable td:nth-of-type(11):before { content: "Acciones:"; }

        #summaryTable td:nth-of-type(1):before { content: "AUC / Grupo / Subgrupo:"; }
        #summaryTable td:nth-of-type(2):before { content: "Presupuesto (MXN):"; }
        #summaryTable td:nth-of-type(3):before { content: "Presupuesto (EUR):"; }
        #summaryTable td:nth-of-type(4):before { content: "Gasto Real (MXN):"; }
        #summaryTable td:nth-of-type(5):before { content: "Gasto Real (EUR):"; }
        #summaryTable td:nth-of-type(6):before { content: "Restante (MXN):"; }
        #summaryTable td:nth-of-type(7):before { content: "Restante (EUR):"; }
        #summaryTable td:nth-of-type(8):before { content: "Avance (%):"; }
    }
</style>
</head>
<body>

<h1>Project Budget Monitoring</h1>

<div class="bg-white p-6 rounded-xl shadow-md mb-6">
    <div class="flex flex-wrap items-center gap-4">
        <label for="mesActual" class="font-semibold">Current Project Month:</label>
        <input type="number" id="mesActual" value="1" min="1" max="24" class="flex-1 min-w-0">
        <label for="duracionProyecto" class="font-semibold">Total Duration (months):</label>
        <input type="number" id="duracionProyecto" value="12" min="1" max="60" class="flex-1 min-w-0">
        <button onclick="calcularForecast()" class="btn-primary">Calculate Forecast</button>
    </div>
    <div id="resultadoForecast" class="mt-4 font-bold text-lg text-center"></div>
</div>

<!-- New AUC Management Section -->
<h2>Register New AUC (Budget Package)</h2>
<form id="aucForm" class="form-inline">
    <input type="text" id="aucNombre" placeholder="AUC Name" required />
    <input type="text" id="aucCodigo" placeholder="AUC Code (Unique)" required />
    <button type="submit" class="btn-primary">Add AUC</button>
</form>

<h2>Registered AUCs</h2>
<table id="tablaAUCs">
    <thead>
        <tr>
            <th>AUC Name</th>
            <th>AUC Code</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- AUC Selector for Budget and Order Forms -->
<div class="bg-white p-6 rounded-xl shadow-md my-6">
    <h2 class="mt-0">Select Active AUC</h2>
    <select id="activeAUCSelect" class="w-full" onchange="updateFormsAndCharts()">
        <option value="">Select an AUC to manage budgets/orders</option>
    </select>
</div>

<h2>Register Purchase Order</h2>
<form id="orderForm" class="form-inline">
Â  <input type="hidden" id="editIndex" value="-1" />
  <input type="hidden" id="orderAucCode" /> <!-- Hidden field to store selected AUC code -->
Â  <input type="date" id="fecha" required />
Â  <input type="text" id="numCarrito" placeholder="Cart #" required />
Â  <input type="text" id="ordenCompra" placeholder="Purchase Order" required />
Â  <select id="grupo" required></select>
Â  <select id="subgrupo" required></select>
Â  <input type="number" id="montoMXN" placeholder="Amount MXN" min="0" step="0.01" required />
Â  <input type="text" id="comentarios" placeholder="Comments" />
Â  <input type="text" id="contratista" placeholder="Contractor" />
Â  <button type="submit" class="btn-primary">Save</button>
Â  <button type="button" id="cancelEditBtn" style="display:none;" class="btn-warning">Cancel Edit</button>
</form>

<h2>Register Budgets</h2>
<form id="formPresupuesto" class="form-inline">
  <input type="hidden" id="budgetAucCode" /> <!-- Hidden field to store selected AUC code -->
Â  <label for="grupoPresupuesto" class="font-semibold">Group:</label>
Â  <select id="grupoPresupuesto" required></select>
Â  <label for="subgrupoPresupuesto" class="font-semibold">Subgroup:</label>
Â  <input type="text" id="subgrupoPresupuesto" required>
Â  <label for="montoPresupuesto" class="font-semibold">Budget Amount MXN:</label>
Â  <input type="number" id="montoPresupuesto" step="0.01" required> <!-- Added step="0.01" here -->
Â  <button type="submit" class="btn-primary">Add Budget</button>
</form>

<table id="tablaPresupuestos">
Â  <thead>
Â  Â  <tr>
      <th>AUC</th>
Â  Â  Â  <th>Group</th>
      <th>Subgroup</th>
      <th>Budget MXN</th>
      <th>Accumulated Expense</th>
      <th>Remaining</th>
      <th>% Used</th>
      <th>Actions</th>
Â  Â  </tr>
Â  </thead>
Â  <tbody></tbody>
</table>

<h2>Registered Orders</h2>
<table id="ordersTable">
Â  <thead>
Â  Â  <tr>
      <th>AUC</th>
Â  Â  Â  <th>Date</th>
      <th>Cart #</th>
      <th>Purchase Order</th>
      <th>Group</th>
      <th>Subgroup</th>
      <th>Amount MXN</th>
      <th>Amount EUR</th>
      <th>Comments</th>
      <th>Contratista</th>
      <th>Actions</th>
Â  Â  </tr>
Â  </thead>
Â  <tbody></tbody>
</table>

<h2>Budget Summary</h2>
<table id="summaryTable">
Â  <thead>
Â  Â  <tr>
Â  Â  Â  <th>AUC / Group / Subgroup</th>
      <th>Budget (MXN)</th>
      <th>Budget (EUR)</th>
      <th>Actual Expense (MXN)</th>
      <th>Actual Expense (EUR)</th>
      <th>Remaining (MXN)</th>
      <th>Remaining (EUR)</th>
      <th>Progress (%)</th>
Â  Â  </tr>
Â  </thead>
Â  <tbody></tbody>
</table>

<div class="mt-8 flex justify-end gap-4">
    <button onclick="exportData('presupuestos')" class="btn-success">Export Budgets to Excel</button>
    <button onclick="exportData('orders')" class="btn-success">Export Orders to Excel</button>
    <button onclick="exportData('summary')" class="btn-success">Export Summary to Excel</button>
</div>


<h2>Budget Progress by Group (%)</h2>
<canvas id="progressChart" class="mt-6"></canvas>

<h2>Budget vs. Expense Comparison</h2>
<h3 class="mt-4 mb-2">Filter by AUC / Group / Subgroup</h3>
<div class="flex flex-wrap gap-4 mb-4">
    <select id="filtroAUC" class="flex-1 min-w-0" onchange="handleFilterChange(event)"></select>
    <select id="filtroGrupo" class="flex-1 min-w-0" onchange="handleFilterChange(event)"></select>
    <select id="filtroSubgrupo" class="flex-1 min-w-0" onchange="handleFilterChange(event)"></select>
</div>
<canvas id="grafica"></canvas>

<!-- Script for Chart.js and SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
Â  // Global exchange rate
Â  const tasaMXNaEUR = 21.25;

Â  // Data storage: AUCs, Budgets (linked to AUC), Orders (linked to AUC and Budget)
Â  // These lines now correctly load from localStorage if data exists, or initialize as empty arrays if not.
Â  let aucs = JSON.parse(localStorage.getItem("aucs")) || [];
Â  let presupuestos = JSON.parse(localStorage.getItem("presupuestos")) || [];
Â  let orders = JSON.parse(localStorage.getItem("orders")) || [];

Â  // Global variable for currently selected AUC
Â  let activeAUC = null;

Â  // DOM elements
Â  const aucForm = document.getElementById('aucForm');
Â  const tablaAUCsBody = document.querySelector('#tablaAUCs tbody');
Â  const activeAUCSelect = document.getElementById('activeAUCSelect');

Â  const orderForm = document.getElementById('orderForm');
Â  const orderAucCodeInput = document.getElementById('orderAucCode');
Â  const fechaInput = document.getElementById('fecha');
Â  const numCarritoInput = document.getElementById('numCarrito');
Â  const ordenCompraInput = document.getElementById('ordenCompra');
Â  const grupoSelect = document.getElementById('grupo');
Â  const subgrupoSelect = document.getElementById('subgrupo');
Â  const montoMXNInput = document.getElementById('montoMXN');
Â  const comentariosInput = document.getElementById('comentarios');
Â  const contratistaInput = document.getElementById('contratista');
Â  const editIndexInput = document.getElementById('editIndex');
Â  const cancelEditBtn = document.getElementById('cancelEditBtn');
Â  const ordersTableBody = document.querySelector('#ordersTable tbody');

Â  const formPresupuesto = document.getElementById("formPresupuesto");
Â  const budgetAucCodeInput = document.getElementById('budgetAucCode');
Â  const grupoPresupuestoSelect = document.getElementById("grupoPresupuesto");
Â  const subgrupoPresupuestoInput = document.getElementById("subgrupoPresupuesto");
Â  const montoPresupuestoInput = document.getElementById("montoPresupuesto");
Â  const tablaPresupuestosBody = document.querySelector("#tablaPresupuestos tbody");

Â  const summaryTableBody = document.querySelector('#summaryTable tbody');
Â  const filtroAUCSelect = document.getElementById("filtroAUC");
Â  const filtroGrupoSelect = document.getElementById("filtroGrupo");
Â  const filtroSubgrupoSelect = document.getElementById("filtroSubgrupo");

Â  // Chart.js instances
Â  let progressChartInstance = null;
Â  let lineChartInstance = null;

Â  // --- General UI and Data Management Functions ---

Â  // Custom message box function (replaces alert())
Â  function displayMessage(message, type = "info") {
Â  Â  let messageBox = document.getElementById("messageBox");
Â  Â  if (!messageBox) {
Â  Â  Â  messageBox = document.createElement("div");
Â  Â  Â  messageBox.id = "messageBox";
Â  Â  Â  messageBox.style.cssText = `
Â  Â  Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px 25px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(-20px);
Â  Â  Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease-out, transform 0.3s ease-out;
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  document.body.appendChild(messageBox);
Â  Â  }

Â  Â  messageBox.textContent = message;
Â  Â  messageBox.style.backgroundColor = ""; // Reset background
Â  Â  if (type === "success") {
Â  Â  Â  messageBox.style.backgroundColor = "#28a745";
Â  Â  } else if (type === "error") {
Â  Â  Â  messageBox.style.backgroundColor = "#dc3545";
Â  Â  } else if (type === "warning") {
Â  Â  Â  messageBox.style.backgroundColor = "#ffc107";
Â  Â  Â  messageBox.style.color = "#333";
Â  Â  } else {
Â  Â  Â  messageBox.style.backgroundColor = "#007bff";
Â  Â  }

Â  Â  messageBox.style.opacity = 1;
Â  Â  messageBox.style.transform = "translateY(0)";

Â  Â  setTimeout(() => {
Â  Â  Â  messageBox.style.opacity = 0;
Â  Â  Â  messageBox.style.transform = "translateY(-20px)";
Â  Â  }, 3000);
Â  }

Â  // --- AUC Management ---

Â  aucForm.addEventListener('submit', function(e) {
Â  Â  e.preventDefault();
Â  Â  const nombre = document.getElementById('aucNombre').value.trim();
Â  Â  const codigo = document.getElementById('aucCodigo').value.trim();

Â  Â  if (!nombre || !codigo) {
Â  Â  Â  displayMessage("Please enter both AUC Name and AUC Code.", "error");
Â  Â  Â  return;
Â  Â  }
Â  Â  if (aucs.some(a => a.codigo === codigo)) {
Â  Â  Â  displayMessage("An AUC with this code already exists.", "warning");
Â  Â  Â  return;
Â  Â  }

Â  Â  aucs.push({ nombre, codigo });
Â  Â  localStorage.setItem("aucs", JSON.stringify(aucs));
Â  Â  renderAUCs();
Â  Â  initAUCSelects(); // Update AUC dropdowns
Â  Â  this.reset();
Â  Â  displayMessage("AUC added successfully!", "success");
Â  });

Â  function renderAUCs() {
Â  Â  tablaAUCsBody.innerHTML = "";
Â  Â  if (aucs.length === 0) {
Â  Â  Â  tablaAUCsBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">No AUCs registered yet.</td></tr>';
Â  Â  Â  return;
Â  Â  }
Â  Â  aucs.forEach((auc, i) => {
Â  Â  Â  const row = document.createElement("tr");
Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  <td data-label="AUC Name">${auc.nombre}</td>
Â  Â  Â  Â  <td data-label="AUC Code">${auc.codigo}</td>
Â  Â  Â  Â  <td data-label="Actions">
Â  Â  Â  Â  Â  <button onclick="deleteAUC(${i})" class="btn-danger">Delete</button>
Â  Â  Â  Â  </td>
Â  Â  Â  `;
Â  Â  Â  tablaAUCsBody.appendChild(row);
Â  Â  });
Â  }

Â  window.deleteAUC = function(index) {
Â  Â  const aucToDelete = aucs[index];
Â  Â  if (confirm(`Are you sure you want to delete AUC "${aucToDelete.nombre}" (${aucToDelete.codigo})? This will also delete all associated budgets and orders.`)) {
Â  Â  Â  // Remove associated budgets and orders first
Â  Â  Â  presupuestos = presupuestos.filter(p => p.auc !== aucToDelete.codigo);
Â  Â  Â  orders = orders.filter(o => o.auc !== aucToDelete.codigo);

Â  Â  Â  // Remove the AUC itself
Â  Â  Â  aucs.splice(index, 1);
Â  Â  Â  localStorage.setItem("aucs", JSON.stringify(aucs));
Â  Â  Â  localStorage.setItem("presupuestos", JSON.stringify(presupuestos));
Â  Â  Â  localStorage.setItem("orders", JSON.stringify(orders));

Â  Â  Â  if (activeAUC && activeAUC.codigo === aucToDelete.codigo) {
Â  Â  Â  Â  activeAUC = null; // Clear active AUC if deleted
Â  Â  Â  }
Â  Â  Â  updateFormsAndCharts();
Â  Â  Â  displayMessage("AUC and associated data deleted.", "success");
Â  Â  }
Â  };

Â  function initAUCSelects() {
Â  Â  // Populate the active AUC selector
Â  Â  activeAUCSelect.innerHTML = '<option value="">Select an AUC to manage budgets/orders</option>' +
Â  Â  Â  aucs.map(a => `<option value="${a.codigo}" ${activeAUC && activeAUC.codigo === a.codigo ? 'selected' : ''}>${a.nombre} (${a.codigo})</option>`).join('');

Â  Â  // Populate chart filter AUC selector
Â  Â  filtroAUCSelect.innerHTML = '<option value="todos">All AUCs</option>' +
Â  Â  Â  aucs.map(a => `<option value="${a.codigo}">${a.nombre} (${a.codigo})</option>`).join('');
Â  }

Â  function updateFormsAndCharts() {
Â  Â  const selectedCode = activeAUCSelect.value;
Â  Â  activeAUC = aucs.find(a => a.codigo === selectedCode) || null;

Â  Â  // Enable/disable forms based on active AUC
Â  Â  const forms = [orderForm, formPresupuesto];
Â  Â  forms.forEach(form => {
Â  Â  Â  form.style.opacity = activeAUC ? '1' : '0.5';
Â  Â  Â  Array.from(form.elements).forEach(element => {
Â  Â  Â  Â  if (element.type !== 'hidden') {
Â  Â  Â  Â  Â  element.disabled = !activeAUC;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });

Â  Â  // Set hidden AUC code inputs for forms
Â  Â  orderAucCodeInput.value = activeAUC ? activeAUC.codigo : '';
Â  Â  budgetAucCodeInput.value = activeAUC ? activeAUC.codigo : '';

Â  Â  // Update dropdowns (Grupo/Subgrupo) in forms and charts
Â  Â  updateGrupoSubgrupoSelects();
Â  Â  renderPresupuestos();
Â  Â  renderOrdersTable();
Â  Â  renderSummaryTable();
Â  Â  updateProgressChart();
Â  Â  cargarFiltros(); // Re-load filters with current AUC context
Â  Â  generarGrafica();
Â  Â  calcularForecast();
Â  }

Â  function updateGrupoSubgrupoSelects() {
Â  Â  // Update Group select for order form
Â  Â  let availableGroups = [];
Â  Â  if (activeAUC) {
Â  Â  Â  availableGroups = [...new Set(presupuestos
Â  Â  Â  Â  .filter(p => p.auc === activeAUC.codigo)
Â  Â  Â  Â  .map(p => p.grupo))].sort();
Â  Â  }
Â  Â  grupoSelect.innerHTML = '<option value="">Select Group</option>' + availableGroups.map(g => `<option value="${g}">${g}</option>`).join('');
Â  Â  subgrupoSelect.innerHTML = '<option value="">Select Subgroup</option>'; // Clear subgroup on group change

Â  Â  // Update Group select for budget form
    let availableBudgetGroups = [];
    if (activeAUC) {
        // Get groups already defined for the active AUC
        availableBudgetGroups = [...new Set(presupuestos
            .filter(p => p.auc === activeAUC.codigo)
            .map(p => p.grupo))].sort();
    }
    
    // Add some common default groups if no AUC selected or no groups yet
    const commonGroups = ["Equipment", "Mechanical", "Electrical", "Automation", "CSA", "Personnel", "Engineering", "HVAC", "Black Utilities", "Cubierta", "MEP"];
    
    // Combine existing groups with common groups without duplicates
    const finalBudgetGroups = [...new Set([...availableBudgetGroups, ...commonGroups])].sort();

    grupoPresupuestoSelect.innerHTML = '<option value="">Select Group</option>' + finalBudgetGroups.map(g => `<option value="${g}">${g}</option>`).join('');
Â  }

Â  // Dynamically populate subgroups in order form based on selected group and AUC
Â  grupoSelect.addEventListener('change', () => {
Â  Â  const selectedGroup = grupoSelect.value;
Â  Â  let availableSubgroups = [];
Â  Â  if (activeAUC && selectedGroup) {
Â  Â  Â  availableSubgroups = [...new Set(presupuestos
Â  Â  Â  Â  .filter(p => p.auc === activeAUC.codigo && p.grupo === selectedGroup)
Â  Â  Â  Â  .map(p => p.subgrupo))].sort();
Â  Â  }
Â  Â  subgrupoSelect.innerHTML = '<option value="">Select Subgroup</option>' + availableSubgroups.map(sg => `<option value="${sg}">${sg}</option>`).join('');
Â  });

Â  // --- Budget Management ---

Â  formPresupuesto.addEventListener("submit", function(e) {
Â  Â  e.preventDefault();
Â  Â  if (!activeAUC) {
Â  Â  Â  displayMessage("Please select an active AUC first.", "warning");
Â  Â  Â  return;
Â  Â  }

Â  Â  const auc = budgetAucCodeInput.value;
Â  Â  const grupo = grupoPresupuestoSelect.value;
Â  Â  const subgrupo = subgrupoPresupuestoInput.value.trim();
Â  Â  const monto = parseFloat(montoPresupuestoInput.value);

Â  Â  if (!grupo || !subgrupo || isNaN(monto) || monto <= 0) {
Â  Â  Â  displayMessage("Please complete all budget fields and ensure the amount is a positive number.", "error");
Â  Â  Â  return;
Â  Â  }

Â  Â  const existente = presupuestos.find(p => p.auc === auc && p.grupo === grupo && p.subgrupo === subgrupo);
Â  Â  if (existente) {
Â  Â  Â  displayMessage("This budget already exists for this AUC/Group/Subgroup. Edit it if you wish to modify it.", "warning");
Â  Â  Â  return;
Â  Â  }

Â  Â  presupuestos.push({ auc, grupo, subgrupo, monto });
Â  Â  localStorage.setItem("presupuestos", JSON.stringify(presupuestos));
Â  Â  updateFormsAndCharts(); // Re-render all relevant parts
Â  Â  this.reset();
Â  Â  displayMessage("Budget added successfully!", "success");
Â  });

Â  function renderPresupuestos() {
Â  Â  tablaPresupuestosBody.innerHTML = "";
Â  Â  const filteredPresupuestos = activeAUC ? presupuestos.filter(p => p.auc === activeAUC.codigo) : []; // Ensure it's empty if no active AUC

    if (filteredPresupuestos.length === 0) {
        tablaPresupuestosBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500">${activeAUC ? `No budgets registered for AUC: ${activeAUC.nombre} (${activeAUC.codigo}).` : 'Please select an AUC or register new budgets.'}</td></tr>`;
        return;
    }

Â  Â  filteredPresupuestos.forEach((p, i) => {
Â  Â  Â  const gasto = calcularGastoPorSubgrupo(p.auc, p.grupo, p.subgrupo);
Â  Â  Â  const restante = p.monto - gasto;
Â  Â  Â  const porcentaje = p.monto > 0 ? ((gasto / p.monto) * 100).toFixed(1) : 0;

Â  Â  Â  const row = document.createElement("tr");
Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  <td data-label="AUC">${p.auc}</td>
Â  Â  Â  Â  <td data-label="Group">${p.grupo}</td>
Â  Â  Â  Â  <td data-label="Subgroup">${p.subgrupo}</td>
Â  Â  Â  Â  <td data-label="Budget MXN">$${p.monto.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
Â  Â  Â  Â  <td data-label="Accumulated Expense">$${gasto.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
Â  Â  Â  Â  <td data-label="Remaining">$${restante.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
Â  Â  Â  Â  <td data-label="% Used">${porcentaje}%</td>
Â  Â  Â  Â  <td data-label="Actions">
Â  Â  Â  Â  Â  <button onclick="editarPresupuesto('${p.auc}', '${p.grupo}', '${p.subgrupo}')" class="btn-warning">Edit</button>
Â  Â  Â  Â  Â  <button onclick="eliminarPresupuesto('${p.auc}', '${p.grupo}', '${p.subgrupo}')" class="btn-danger">Delete</button>
Â  Â  Â  Â  </td>
Â  Â  Â  `;
Â  Â  Â  tablaPresupuestosBody.appendChild(row);
Â  Â  });
Â  }

Â  window.editarPresupuesto = function(aucCode, groupName, subgroupName) {
Â  Â  const p = presupuestos.find(p => p.auc === aucCode && p.grupo === groupName && p.subgrupo === subgroupName);
Â  Â  if (!p) return;

Â  Â  let nuevoMonto = prompt(`Edit amount for AUC: ${p.auc}, Group: ${p.grupo}, Subgroup: ${p.subgrupo}:`, p.monto);
Â  Â  if (nuevoMonto !== null) {
Â  Â  Â  nuevoMonto = parseFloat(nuevoMonto);
Â  Â  Â  if (!isNaN(nuevoMonto) && nuevoMonto >= 0) {
Â  Â  Â  Â  p.monto = nuevoMonto;
Â  Â  Â  Â  localStorage.setItem("presupuestos", JSON.stringify(presupuestos));
Â  Â  Â  Â  updateFormsAndCharts();
Â  Â  Â  Â  displayMessage("Budget updated successfully!", "success");
Â  Â  Â  } else {
Â  Â  Â  Â  displayMessage("Invalid amount. Please enter a positive number.", "error");
Â  Â  Â  }
Â  Â  }
Â  };

Â  window.eliminarPresupuesto = function(aucCode, groupName, subgroupName) {
Â  Â  if (confirm(`Are you sure you want to delete budget for AUC: ${aucCode}, Group: ${groupName}, Subgroup: ${subgroupName}? This will not delete associated orders.`)) {
Â  Â  Â  presupuestos = presupuestos.filter(p => !(p.auc === aucCode && p.grupo === groupName && p.subgrupo === subgroupName));
Â  Â  Â  localStorage.setItem("presupuestos", JSON.stringify(presupuestos));
Â  Â  Â  updateFormsAndCharts();
Â  Â  Â  displayMessage("Budget deleted successfully!", "success");
Â  Â  }
Â  };

Â  // --- Purchase Order Management ---

Â  orderForm.addEventListener('submit', e => {
Â  Â  e.preventDefault();
Â  Â  if (!activeAUC) {
Â  Â  Â  displayMessage("Please select an active AUC first to register orders.", "warning");
Â  Â  Â  return;
Â  Â  }

Â  Â  const auc = orderAucCodeInput.value;
Â  Â  const fecha = fechaInput.value;
Â  Â  const numCarrito = numCarritoInput.value.trim();
Â  Â  const ordenCompra = ordenCompraInput.value.trim();
Â  Â  const grupo = grupoSelect.value;
Â  Â  const subgrupo = subgrupoSelect.value;
Â  Â  const montoMXN = parseFloat(montoMXNInput.value);
Â  Â  const comentarios = comentariosInput.value.trim();
Â  Â  const contratista = contratistaInput.value.trim();

Â  Â  if (!fecha || !numCarrito || !ordenCompra || !grupo || !subgrupo || isNaN(montoMXN) || montoMXN <= 0) {
Â  Â  Â  displayMessage('Please complete all required fields and ensure the amount is a positive number.', 'error');
Â  Â  Â  return;
Â  Â  }

Â  Â  // Validate that budget exists for this AUC/Group/Subgroup
Â  Â  const existingBudget = presupuestos.find(p => p.auc === auc && p.grupo === grupo && p.subgrupo === subgrupo);
Â  Â  if (!existingBudget) {
Â  Â  Â  displayMessage(`No budget found for AUC: ${auc}, Group: ${grupo}, Subgroup: ${subgrupo}. Please register a budget first.`, "error");
Â  Â  Â  return;
Â  Â  }

Â  Â  const orderData = { auc, fecha, numCarrito, ordenCompra, grupo, subgrupo, montoMXN, comentarios, contratista };
Â  Â  const editIndex = parseInt(editIndexInput.value);

Â  Â  if (editIndex === -1) {
Â  Â  Â  orders.push(orderData);
Â  Â  Â  displayMessage("Order added successfully!", "success");
Â  Â  } else {
Â  Â  Â  orders[editIndex] = orderData;
Â  Â  Â  displayMessage("Order updated successfully!", "success");
Â  Â  }

Â  Â  localStorage.setItem("orders", JSON.stringify(orders));
Â  Â  updateFormsAndCharts();
Â  Â  resetOrderForm();
Â  });

Â  function renderOrdersTable() {
Â  Â  ordersTableBody.innerHTML = '';
Â  Â  const filteredOrders = activeAUC ? orders.filter(o => o.auc === activeAUC.codigo) : []; // Ensure it's empty if no active AUC

    if (filteredOrders.length === 0) {
        ordersTableBody.innerHTML = `<tr><td colspan="11" class="text-center text-gray-500">${activeAUC ? `No orders registered for AUC: ${activeAUC.nombre} (${activeAUC.codigo}).` : 'Please select an AUC or register new orders.'}</td></tr>`;
        return;
    }

Â  Â  filteredOrders.forEach((order, i) => {
Â  Â  Â  const montoEUR = (order.montoMXN / tasaMXNaEUR).toFixed(2);
Â  Â  Â  ordersTableBody.innerHTML += `
Â  Â  Â  Â  <tr>
            <td data-label="AUC">${order.auc}</td>
Â  Â  Â  Â  Â  <td data-label="Date">${order.fecha}</td>
Â  Â  Â  Â  Â  <td data-label="Cart #">${order.numCarrito}</td>
Â  Â  Â  Â  Â  <td data-label="Purchase Order">${order.ordenCompra}</td>
Â  Â  Â  Â  Â  <td data-label="Group">${order.grupo}</td>
Â  Â  Â  Â  Â  <td data-label="Subgroup">${order.subgrupo}</td>
Â  Â  Â  Â  Â  <td data-label="Amount MXN">$${order.montoMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
Â  Â  Â  Â  Â  <td data-label="Amount EUR">â¬${parseFloat(montoEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
Â  Â  Â  Â  Â  <td data-label="Comments">${order.comentarios}</td>
Â  Â  Â  Â  Â  <td data-label="Contratista">${order.contratista}</td>
Â  Â  Â  Â  Â  <td data-label="Actions">
Â  Â  Â  Â  Â  Â  <button onclick="editOrder(${i})" class="btn-warning">Edit</button>
Â  Â  Â  Â  Â  Â  <button onclick="deleteOrder(${i})" class="btn-danger">Delete</button>
Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>
Â  Â  Â  `;
Â  Â  });
Â  }

Â  window.editOrder = function(index) {
Â  Â  const order = orders[index];
    // Set active AUC in the selector if it's different from the current one
    if (activeAUC && activeAUC.codigo !== order.auc) {
        activeAUCSelect.value = order.auc;
        updateFormsAndCharts(); // This will re-populate group/subgroup selects
    } else if (!activeAUC) { // If no AUC was selected, select this order's AUC
        activeAUCSelect.value = order.auc;
        updateFormsAndCharts();
    }

Â  Â  fechaInput.value = order.fecha;
Â  Â  numCarritoInput.value = order.numCarrito;
Â  Â  ordenCompraInput.value = order.ordenCompra;
Â  Â  grupoSelect.value = order.grupo;

Â  Â  // Manually trigger change to ensure subgroups load based on the now-selected group
Â  Â  const event = new Event('change');
Â  Â  grupoSelect.dispatchEvent(event);

Â  Â  subgrupoSelect.value = order.subgrupo;
Â  Â  montoMXNInput.value = order.montoMXN;
Â  Â  comentariosInput.value = order.comentarios;
Â  Â  contratistaInput.value = order.contratista;

Â  Â  editIndexInput.value = index;
Â  Â  cancelEditBtn.style.display = 'inline-block';
Â  };

Â  window.deleteOrder = function(index) {
Â  Â  if (confirm('Are you sure you want to delete this order?')) {
Â  Â  Â  orders.splice(index, 1);
Â  Â  Â  localStorage.setItem("orders", JSON.stringify(orders));
Â  Â  Â  updateFormsAndCharts();
Â  Â  Â  resetOrderForm();
Â  Â  Â  displayMessage("Order deleted successfully!", "success");
Â  Â  }
Â  };

Â  function resetOrderForm() {
Â  Â  orderForm.reset();
Â  Â  editIndexInput.value = -1;
Â  Â  cancelEditBtn.style.display = 'none';
Â  Â  // Keep active AUC selected, clear other fields
Â  Â  grupoSelect.innerHTML = '<option value="">Select Group</option>';
Â  Â  subgrupoSelect.innerHTML = '<option value="">Select Subgroup</option>';
Â  }

Â  cancelEditBtn.addEventListener('click', () => {
Â  Â  resetOrderForm();
Â  });

Â  // Helper to calculate accumulated expense for a specific AUC, Group, and Subgroup
Â  function calcularGastoPorSubgrupo(auc, grupo, subgrupo) {
Â  Â  return orders
Â  Â  Â  .filter(o => o.auc === auc && o.grupo === grupo && o.subgrupo === subgrupo)
Â  Â  Â  .reduce((acc, curr) => acc + parseFloat(curr.montoMXN), 0);
Â  }

Â  // --- Summary Table ---

Â  function renderSummaryTable() {
Â  Â  summaryTableBody.innerHTML = '';
Â  Â  
    // Group budgets by AUC, then by Group, then by Subgroup
    const groupedData = {};

    presupuestos.forEach(p => {
        if (!groupedData[p.auc]) {
            groupedData[p.auc] = {
                nombre: aucs.find(a => a.codigo === p.auc)?.nombre || p.auc,
                groups: {}
            };
        }
        if (!groupedData[p.auc].groups[p.grupo]) {
            groupedData[p.auc].groups[p.grupo] = {
                subgroups: {}
            };
        }
        groupedData[p.auc].groups[p.grupo].subgroups[p.subgrupo] = {
            presupuestoMXN: p.monto
        };
    });

    const filteredAUCs = filtroAUCSelect.value === "todos" 
        ? Object.keys(groupedData) 
        : [filtroAUCSelect.value].filter(auc => groupedData[auc]);

    filteredAUCs.sort().forEach(aucCode => {
        const aucData = groupedData[aucCode];
        let totalAucPresupuestoMXN = 0;
        let totalAucGastoMXN = 0;

        const filteredGroups = filtroGrupoSelect.value === "todos" 
            ? Object.keys(aucData.groups) 
            : [filtroGrupoSelect.value].filter(group => aucData.groups[group]);

        filteredGroups.sort().forEach(groupName => {
            const groupData = aucData.groups[groupName];
            let totalGroupPresupuestoMXN = 0;
            let totalGroupGastoMXN = 0;

            const filteredSubgroups = filtroSubgrupoSelect.value === "todos" 
                ? Object.keys(groupData.subgroups) 
                : [filtroSubgrupoSelect.value].filter(subgroup => groupData.subgroups[subgroup]);

            filteredSubgroups.sort().forEach(subgroupName => {
                const subgroupData = groupData.subgroups[subgroupName];
                const presupuestoMXN = subgroupData.presupuestoMXN;
                const gastoMXN = calcularGastoPorSubgrupo(aucCode, groupName, subgroupName);
                const restanteMXN = presupuestoMXN - gastoMXN;
                const avancePct = presupuestoMXN === 0 ? 0 : (gastoMXN / presupuestoMXN * 100);

                summaryTableBody.innerHTML += `
                    <tr>
                        <td data-label="AUC / Group / Subgroup" class="pl-8">${aucData.nombre} > ${groupName} > ${subgroupName}</td>
                        <td data-label="Budget (MXN)">$${presupuestoMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Budget (EUR)">â¬${(presupuestoMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Actual Expense (MXN)">$${gastoMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Actual Expense (EUR)">â¬${(gastoMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Remaining (MXN)">$${restanteMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Remaining (EUR)">â¬${(restanteMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Progress (%)">${avancePct.toFixed(2)}%</td>
                    </tr>
                `;
                totalGroupPresupuestoMXN += presupuestoMXN;
                totalGroupGastoMXN += gastoMXN;
            });

            // Display Group Totals if there are multiple subgroups or it's the only one
            if (filteredSubgroups.length > 0) {
                const totalGroupRestanteMXN = totalGroupPresupuestoMXN - totalGroupGastoMXN;
                const totalGroupAvance = totalGroupPresupuestoMXN === 0 ? 0 : (totalGroupGastoMXN / totalGroupPresupuestoMXN * 100);
                summaryTableBody.innerHTML += `
                    <tr class="total-group">
                        <td data-label="Group Total" class="pl-4">${groupName} Total</td>
                        <td data-label="Budget (MXN)">$${totalGroupPresupuestoMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Budget (EUR)">â¬${(totalGroupPresupuestoMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Actual Expense (MXN)">$${totalGroupGastoMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Actual Expense (EUR)">â¬${(totalGroupGastoMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Remaining (MXN)">$${totalGroupRestanteMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Remaining (EUR)">â¬${(totalGroupRestanteMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        <td data-label="Progress (%)">${totalGroupAvance.toFixed(2)}%</td>
                    </tr>
                `;
            }
            totalAucPresupuestoMXN += totalGroupPresupuestoMXN;
            totalAucGastoMXN += totalGroupGastoMXN;
        });

        // Display AUC Totals
        if (filteredGroups.length > 0) {
            const totalAucRestanteMXN = totalAucPresupuestoMXN - totalAucGastoMXN;
            const totalAucAvance = totalAucPresupuestoMXN === 0 ? 0 : (totalAucGastoMXN / totalAucPresupuestoMXN * 100);
            summaryTableBody.innerHTML += `
                <tr class="total-auc">
                    <td data-label="AUC Total">${aucData.nombre} (${aucCode}) Total</td>
                    <td data-label="Budget (MXN)">$${totalAucPresupuestoMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                    <td data-label="Budget (EUR)">â¬${(totalAucPresupuestoMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                    <td data-label="Actual Expense (MXN)">$${totalAucGastoMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                    <td data-label="Actual Expense (EUR)">â¬${(totalAucGastoMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                    <td data-label="Remaining (MXN)">$${totalAucRestanteMXN.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                    <td data-label="Remaining (EUR)">â¬${(totalAucRestanteMXN / tasaMXNaEUR).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                    <td data-label="Progress (%)">${totalAucAvance.toFixed(2)}%</td>
                </tr>
            `;
        }
    });

    if (filteredAUCs.length === 0) {
        summaryTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">No data available for the selected filters. Please add AUCs, budgets, and orders.</td></tr>';
    }
}


Â  // --- Forecast Functions ---

Â  function calcularForecast() {
Â  Â  const mesActual = parseInt(document.getElementById("mesActual").value);
Â  Â  const duracion = parseInt(document.getElementById("duracionProyecto").value);
Â  Â  if (isNaN(mesActual) || isNaN(duracion) || mesActual <= 0 || duracion <= 0 || mesActual > duracion) {
Â  Â  Â  document.getElementById("resultadoForecast").innerHTML = "<span class='text-red-600'>Please verify duration and current month data. They must be positive numbers and the current month cannot be greater than the total duration.</span>";
Â  Â  Â  return;
Â  Â  }

    // Calculate forecast based on filtered data if filters are applied, otherwise on all data.
    let totalGastado = 0;
    let totalPresupuesto = 0;

    const currentFiltroAuc = filtroAUCSelect.value;
    const currentFiltroGrupo = filtroGrupoSelect.value;
    const currentFiltroSubgrupo = filtroSubgrupoSelect.value;

    // Sum all relevant expenses
    orders.forEach(order => {
        const matchesFilter = (currentFiltroAuc === "todos" || order.auc === currentFiltroAuc) &&
                              (currentFiltroGrupo === "todos" || order.grupo === currentFiltroGrupo) &&
                              (currentFiltroSubgrupo === "todos" || order.subgrupo === currentFiltroSubgrupo);
        if (matchesFilter) {
            totalGastado += parseFloat(order.montoMXN || 0);
        }
    });

    // Sum all relevant budgets
    presupuestos.forEach(budget => {
        const matchesFilter = (currentFiltroAuc === "todos" || budget.auc === currentFiltroAuc) &&
                              (currentFiltroGrupo === "todos" || budget.grupo === currentFiltroGrupo) &&
                              (currentFiltroSubgrupo === "todos" || budget.subgrupo === currentFiltroSubgrupo);
        if (matchesFilter) {
            totalPresupuesto += parseFloat(budget.monto || 0);
        }
    });


Â  Â  const gastoMensual = totalGastado / mesActual;
Â  Â  const forecast = gastoMensual * duracion;

Â  Â  let mensaje = `
Â  Â  Â  Accumulated Expense: <span class="text-indigo-700 font-bold">$${totalGastado.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} MXN</span><br>
Â  Â  Â  Monthly Average: <span class="text-indigo-700 font-bold">$${gastoMensual.toFixed(2).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} MXN</span><br>
Â  Â  Â  Total Projected Forecast: <span class="text-indigo-700 font-bold">$${forecast.toFixed(2).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} MXN</span><br>
Â  Â  Â  Total Assigned Budget: <span class="text-indigo-700 font-bold">$${totalPresupuesto.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} MXN</span><br>
Â  Â  `;

Â  Â  if (totalPresupuesto === 0) {
Â  Â  Â  Â  mensaje += `<span class="text-yellow-600">No total budget defined for the selected filters.</span>`;
Â  Â  } else if (forecast > totalPresupuesto) {
Â  Â  Â  mensaje += `<span class="text-red-600">â ï¸ <b>Alert!</b> You are projected to exceed the budget by <b>$${Math.round(forecast - totalPresupuesto).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} MXN</b></span>`;
Â  Â  } else {
Â  Â  Â  mensaje += `<span class="text-green-600">â Forecast is within budget (remaining <b>$${Math.round(totalPresupuesto - forecast).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} MXN</b>)</span>`;
Â  Â  }

Â  Â  document.getElementById("resultadoForecast").innerHTML = mensaje;
Â  }


Â  // --- Chart.js Graphs ---

Â  function updateProgressChart() {
Â  Â  const currentFiltroAuc = filtroAUCSelect.value;
Â  Â  const currentFiltroGrupo = filtroGrupoSelect.value;

Â  Â  const filteredPresupuestosForChart = presupuestos.filter(p => 
        (currentFiltroAuc === "todos" || p.auc === currentFiltroAuc) &&
        (currentFiltroGrupo === "todos" || p.grupo === currentFiltroGrupo)
    );

    // Group data for the chart by the relevant level (Group or Subgroup)
    let chartLabels = [];
    let chartData = [];

    if (currentFiltroGrupo === "todos") { // Chart by Group (or AUC if no groups defined)
        const groupsMap = {};
        filteredPresupuestosForChart.forEach(p => {
            const label = currentFiltroAuc === "todos" ? `${p.auc} > ${p.grupo}` : p.grupo;
            if (!groupsMap[label]) {
                groupsMap[label] = { presupuestoTotal: 0, gastoTotal: 0 };
            }
            groupsMap[label].presupuestoTotal += p.monto;
            groupsMap[label].gastoTotal += calcularGastoPorSubgrupo(p.auc, p.grupo, p.subgrupo);
        });

        chartLabels = Object.keys(groupsMap).sort();
        chartData = chartLabels.map(label => {
            const data = groupsMap[label];
            return data.presupuestoTotal === 0 ? 0 : (data.gastoTotal / data.presupuestoTotal) * 100;
        });

    } else { // Chart by Subgroup within a selected Group
        const subgroupsMap = {};
        filteredPresupuestosForChart.forEach(p => {
            if (p.grupo === currentFiltroGrupo) {
                const label = p.subgrupo;
                if (!subgroupsMap[label]) {
                    subgroupsMap[label] = { presupuestoTotal: 0, gastoTotal: 0 };
                }
                subgroupsMap[label].presupuestoTotal += p.monto;
                subgroupsMap[label].gastoTotal += calcularGastoPorSubgrupo(p.auc, p.grupo, p.subgrupo);
            }
        });
        chartLabels = Object.keys(subgroupsMap).sort();
        chartData = chartLabels.map(label => {
            const data = subgroupsMap[label];
            return data.presupuestoTotal === 0 ? 0 : (data.gastoTotal / data.presupuestoTotal) * 100;
        });
    }

Â  Â  if (progressChartInstance) progressChartInstance.destroy();

Â  Â  const ctx = document.getElementById('progressChart').getContext('2d');
Â  Â  progressChartInstance = new Chart(ctx, {
Â  Â  Â  type: 'bar',
Â  Â  Â  data: {
Â  Â  Â  Â  labels: chartLabels,
Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  label: 'Budget Progress (%)',
Â  Â  Â  Â  Â  data: chartData.map(a => a.toFixed(2)),
Â  Â  Â  Â  Â  backgroundColor: 'rgba(59, 130, 246, 0.7)',
Â  Â  Â  Â  Â  borderColor: 'rgba(59, 130, 246, 1)',
Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  y: {
                beginAtZero: true,
                max: 120,
                ticks: {
                    callback: value => value + '%'
                }
            }
Â  Â  Â  Â  },
Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  tooltip: { callbacks: { label: ctx => ctx.parsed.y + '%' } },
Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  text: 'Budget Progress by Group (%)',
            font: {
                size: 16,
                weight: 'bold'
            }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  }

Â  function cargarFiltros() {
Â  Â  // Populate AUC filter
Â  Â  filtroAUCSelect.innerHTML = '<option value="todos">All AUCs</option>' +
Â  Â  Â  aucs.map(a => `<option value="${a.codigo}">${a.nombre} (${a.codigo})</option>`).join("");

Â  Â  // Update cascading filters initially
Â  Â  updateFilterGroupSelect();
Â  Â  updateFilterSubgroupSelect();
Â  }

Â  function handleFilterChange(e) {
Â  Â  if (e.target.id === "filtroAUC") {
Â  Â  Â  updateFilterGroupSelect();
Â  Â  Â  updateFilterSubgroupSelect();
Â  Â  } else if (e.target.id === "filtroGrupo") {
Â  Â  Â  updateFilterSubgroupSelect();
Â  Â  }
Â  Â  // Re-render all data displays and charts with new filters
Â  Â  renderSummaryTable();
Â  Â  updateProgressChart();
Â  Â  generarGrafica();
Â  Â  calcularForecast();
Â  }

Â  function updateFilterGroupSelect() {
Â  Â  const selectedAucCode = filtroAUCSelect.value;
Â  Â  let groups = [];
Â  Â  if (selectedAucCode === "todos") {
Â  Â  Â  groups = [...new Set(presupuestos.map(p => p.grupo))].sort();
Â  Â  } else {
Â  Â  Â  groups = [...new Set(presupuestos.filter(p => p.auc === selectedAucCode).map(p => p.grupo))].sort();
Â  Â  }
Â  Â  filtroGrupoSelect.innerHTML = '<option value="todos">All Groups</option>' + groups.map(g => `<option value="${g}">${g}</option>`).join("");
Â  }

Â  function updateFilterSubgroupSelect() {
Â  Â  const selectedAucCode = filtroAUCSelect.value;
Â  Â  const selectedGroup = filtroGrupoSelect.value;
Â  Â  let subgroups = [];

Â  Â  if (selectedAucCode === "todos" && selectedGroup === "todos") {
Â  Â  Â  subgroups = [...new Set(presupuestos.map(p => p.subgrupo))].sort();
Â  Â  } else if (selectedAucCode !== "todos" && selectedGroup === "todos") {
Â  Â  Â  subgroups = [...new Set(presupuestos.filter(p => p.auc === selectedAucCode).map(p => p.subgrupo))].sort();
Â  Â  } else if (selectedAucCode === "todos" && selectedGroup !== "todos") {
        // This case might be tricky if a group name exists in multiple AUCs
        // For simplicity, we'll get all subgroups for this group name across all AUCs
        subgroups = [...new Set(presupuestos.filter(p => p.grupo === selectedGroup).map(p => p.subgrupo))].sort();
    }
    else {
Â  Â  Â  subgroups = [...new Set(presupuestos.filter(p => p.auc === selectedAucCode && p.grupo === selectedGroup).map(p => p.subgrupo))].sort();
Â  Â  }
Â  Â  filtroSubgrupoSelect.innerHTML = '<option value="todos">All Subgroups</option>' + subgroups.map(s => `<option value="${s}">${s}</option>`).join("");
Â  }

Â  function generarGrafica() {
Â  Â  const currentFiltroAuc = filtroAUCSelect.value;
Â  Â  const currentFiltroGrupo = filtroGrupoSelect.value;
Â  Â  const currentFiltroSubgrupo = filtroSubgrupoSelect.value;

Â  Â  // Filter data based on selected filters for the line chart
Â  Â  const filteredPresupuestos = presupuestos.filter(p => {
Â  Â  Â  return (currentFiltroAuc === "todos" || p.auc === currentFiltroAuc) &&
Â  Â  Â  Â  Â  Â  Â (currentFiltroGrupo === "todos" || p.grupo === currentFiltroGrupo) &&
Â  Â  Â  Â  Â  Â  Â (currentFiltroSubgrupo === "todos" || p.subgrupo === currentFiltroSubgrupo);
Â  Â  });

    // Aggregate data for the line chart
    // If specific sub-group is selected, use it. Otherwise, group by sub-group within the selected group/AUC.
    // If only AUC selected, group by group. If all AUCs, group by AUC then group.
    let labels = [];
    let presupuestosData = [];
    let gastoData = [];
    let restanteData = [];

    const aggregationLevel = (() => {
        if (currentFiltroSubgrupo !== "todos") return "subgroup";
        if (currentFiltroGrupo !== "todos") return "group";
        if (currentFiltroAuc !== "todos") return "auc";
        return "overall"; // Aggregate all data
    })();

    const aggregateMap = {}; // key: label, value: {budget, expense}

    filteredPresupuestos.forEach(p => {
        let label;
        switch (aggregationLevel) {
            case "subgroup":
                label = `${p.auc} > ${p.grupo} > ${p.subgrupo}`; // Full path for specific subgroup
                break;
            case "group":
                label = `${p.auc} > ${p.grupo}`; // Full path for specific group
                break;
            case "auc":
                label = p.auc; // Only AUC code for overall AUC view
                break;
            default: // "overall"
                label = "Total Project"; // Single label for entire project
                break;
        }

        if (!aggregateMap[label]) {
            aggregateMap[label] = { budget: 0, expense: 0 };
        }
        aggregateMap[label].budget += p.monto;
        aggregateMap[label].expense += calcularGastoPorSubgrupo(p.auc, p.grupo, p.subgrupo);
    });

    labels = Object.keys(aggregateMap).sort();
    labels.forEach(label => {
        const data = aggregateMap[label];
        presupuestosData.push(data.budget);
        gastoData.push(data.expense);
        restanteData.push(data.budget - data.expense);
    });

Â  Â  const ctx = document.getElementById("grafica").getContext("2d");
Â  Â  if (lineChartInstance) lineChartInstance.destroy();

Â  Â  lineChartInstance = new Chart(ctx, {
Â  Â  Â  type: "line",
Â  Â  Â  data: {
Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  datasets: [
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  label: "Budget MXN",
Â  Â  Â  Â  Â  Â  data: presupuestosData,
Â  Â  Â  Â  Â  Â  borderColor: "#2ecc71",
Â  Â  Â  Â  Â  Â  backgroundColor: "rgba(46, 204, 113, 0.2)",
Â  Â  Â  Â  Â  Â  tension: 0.3,
Â  Â  Â  Â  Â  Â  fill: false
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  label: "Accumulated Expense MXN",
Â  Â  Â  Â  Â  Â  data: gastoData,
Â  Â  Â  Â  Â  Â  borderColor: "#3b82f6",
Â  Â  Â  Â  Â  Â  backgroundColor: "rgba(59, 130, 246, 0.2)",
Â  Â  Â  Â  Â  Â  tension: 0.3,
Â  Â  Â  Â  Â  Â  fill: false
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  label: "Remaining Amount MXN",
Â  Â  Â  Â  Â  Â  data: restanteData,
Â  Â  Â  Â  Â  Â  borderColor: "#f59e0b",
Â  Â  Â  Â  Â  Â  backgroundColor: "rgba(245, 158, 11, 0.2)",
Â  Â  Â  Â  Â  Â  tension: 0.3,
Â  Â  Â  Â  Â  Â  fill: false
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  position: "top"
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  text: "Budget vs. Expense Comparison",
            font: {
                size: 16,
                weight: 'bold'
            }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  Â  Â  callback: function(value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return '$' + value.toLocaleString();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  }

    // --- Export to Excel Function ---
    window.exportData = function(dataType) {
        let dataToExport = [];
        let sheetName = "";
        let wb = XLSX.utils.book_new();

        if (dataType === 'presupuestos') {
            dataToExport = presupuestos.map(p => ({
                'AUC': p.auc,
                'Grupo': p.grupo,
                'Subgrupo': p.subgrupo,
                'Monto Presupuesto MXN': p.monto
            }));
            sheetName = 'Budgets';
        } else if (dataType === 'orders') {
            dataToExport = orders.map(o => ({
                'AUC': o.auc,
                'Fecha': o.fecha,
                '# Carrito': o.numCarrito,
                'Orden Compra': o.ordenCompra,
                'Grupo': o.grupo,
                'Subgrupo': o.subgrupo,
                'Monto MXN': o.montoMXN,
                'Monto EUR': (o.montoMXN / tasaMXNaEUR).toFixed(2),
                'Comentarios': o.comentarios,
                'Contratista': o.contratista
            }));
            sheetName = 'Orders';
        } else if (dataType === 'summary') {
            // Re-generate summary data for export to ensure it matches current state
            const summaryRows = [];
            const groupedData = {};

            presupuestos.forEach(p => {
                if (!groupedData[p.auc]) {
                    groupedData[p.auc] = {
                        nombre: aucs.find(a => a.codigo === p.auc)?.nombre || p.auc,
                        groups: {}
                    };
                }
                if (!groupedData[p.auc].groups[p.grupo]) {
                    groupedData[p.auc].groups[p.grupo] = {
                        subgroups: {}
                    };
                }
                groupedData[p.auc].groups[p.grupo].subgroups[p.subgrupo] = {
                    presupuestoMXN: p.monto
                };
            });

            Object.keys(groupedData).sort().forEach(aucCode => {
                const aucData = groupedData[aucCode];
                let totalAucPresupuestoMXN = 0;
                let totalAucGastoMXN = 0;

                Object.keys(aucData.groups).sort().forEach(groupName => {
                    const groupData = aucData.groups[groupName];
                    let totalGroupPresupuestoMXN = 0;
                    let totalGroupGastoMXN = 0;

                    Object.keys(groupData.subgroups).sort().forEach(subgroupName => {
                        const subgroupData = groupData.subgroups[subgroupName];
                        const presupuestoMXN = subgroupData.presupuestoMXN;
                        const gastoMXN = calcularGastoPorSubgrupo(aucCode, groupName, subgroupName);
                        const restanteMXN = presupuestoMXN - gastoMXN;
                        const avancePct = presupuestoMXN === 0 ? 0 : (gastoMXN / presupuestoMXN * 100);

                        summaryRows.push({
                            'Level': `${aucData.nombre} > ${groupName} > ${subgroupName}`,
                            'Budget (MXN)': presupuestoMXN,
                            'Budget (EUR)': (presupuestoMXN / tasaMXNaEUR),
                            'Actual Expense (MXN)': gastoMXN,
                            'Actual Expense (EUR)': (gastoMXN / tasaMXNaEUR),
                            'Remaining (MXN)': restanteMXN,
                            'Remaining (EUR)': (restanteMXN / tasaMXNaEUR),
                            'Progress (%)': avancePct.toFixed(2) + '%'
                        });
                        totalGroupPresupuestoMXN += presupuestoMXN;
                        totalGroupGastoMXN += gastoMXN;
                    });

                    if (Object.keys(groupData.subgroups).length > 0) {
                        const totalGroupRestanteMXN = totalGroupPresupuestoMXN - totalGroupGastoMXN;
                        const totalGroupAvance = totalGroupPresupuestoMXN === 0 ? 0 : (totalGroupGastoMXN / totalGroupPresupuestoMXN * 100);
                        summaryRows.push({
                            'Level': `${groupName} Total`,
                            'Budget (MXN)': totalGroupPresupuestoMXN,
                            'Budget (EUR)': (totalGroupPresupuestoMXN / tasaMXNaEUR),
                            'Actual Expense (MXN)': totalGroupGastoMXN,
                            'Actual Expense (EUR)': (totalGroupGastoMXN / tasaMXNaEUR),
                            'Remaining (MXN)': totalGroupRestanteMXN,
                            'Remaining (EUR)': (totalGroupRestanteMXN / tasaMXNaEUR),
                            'Progress (%)': totalGroupAvance.toFixed(2) + '%'
                        });
                    }
                    totalAucPresupuestoMXN += totalGroupPresupuestoMXN;
                    totalAucGastoMXN += totalGroupGastoMXN;
                });

                if (Object.keys(aucData.groups).length > 0) {
                    const totalAucRestanteMXN = totalAucPresupuestoMXN - totalAucGastoMXN;
                    const totalAucAvance = totalAucPresupuestoMXN === 0 ? 0 : (totalAucGastoMXN / totalAucPresupuestoMXN * 100);
                    summaryRows.push({
                        'Level': `${aucData.nombre} (${aucCode}) Total`,
                        'Budget (MXN)': totalAucPresupuestoMXN,
                        'Budget (EUR)': (totalAucPresupuestoMXN / tasaMXNaEUR),
                        'Actual Expense (MXN)': totalAucGastoMXN,
                        'Actual Expense (EUR)': (totalAucGastoMXN / tasaMXNaEUR),
                        'Remaining (MXN)': totalAucRestanteMXN,
                        'Remaining (EUR)': (totalAucRestanteMXN / tasaMXNaEUR),
                        'Progress (%)': totalAucAvance.toFixed(2) + '%'
                    });
                }
            });
            dataToExport = summaryRows;
            sheetName = 'Summary';
        } else {
            displayMessage("Invalid export type.", "error");
            return;
        }

        if (dataToExport.length === 0) {
            displayMessage(`No data to export for ${sheetName}.`, "warning");
            return;
        }

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, `Project_Budget_${sheetName}_Report.xlsx`);
        displayMessage(`Exported ${sheetName} data to Excel successfully!`, "success");
    };


Â  // --- Application Initialization ---
Â  function initializeApp() {
        // IMPORTANT: Removed localStorage.removeItem() calls
        // This ensures that existing data in localStorage will be loaded automatically
        // when the page is opened again.
        
        // The lines below (aucs = JSON.parse(localStorage.getItem("aucs")) || []; etc.)
        // already handle loading existing data or starting empty if no data is found.

Â  Â  renderAUCs();
Â  Â  initAUCSelects();
Â  Â  updateFormsAndCharts(); // This will trigger initial rendering of all tables and charts based on current state
Â  Â  cargarFiltros(); // Ensure filters are populated correctly on load
Â  }

Â  // Call the initialization function when the DOM is loaded
Â  document.addEventListener('DOMContentLoaded', initializeApp);

</script>

</body>
</html>
